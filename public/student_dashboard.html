<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Christ University</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #1E3A8A;
      --secondary: #F1F5F9;
      --accent: #60A5FA;
      --success: #10B981;
      --warning: #FBBF24;
      --text-primary: #1F2937;
      --text-secondary: #6B7280;
      --background: #FFFFFF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: 
        linear-gradient(rgba(30, 58, 138, 0.7), rgba(37, 99, 235, 0.7)),
        url('background.jpg') center/cover no-repeat fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
    }

    /* Header Section */
    .header {
      background: var(--background);
      padding: 20px 32px;
      border-bottom: 1px solid #E5E7EB;
      box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }

    .logo-link {
      display: block;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logo-link:hover {
      transform: scale(1.05);
    }

    .logo {
      height: 50px;
      width: auto;
    }

    .university-info {
      color: var(--primary);
      text-align: center;
      flex: 1;
    }

    .university-name {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
      letter-spacing: 0.5px;
    }

    .portal-subtitle {
      font-size: 14px;
      opacity: 0.8;
      font-weight: 500;
      letter-spacing: 0.25px;
      color: var(--text-secondary);
    }

    .logout-icon {
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
      color: var(--text-secondary);
    }

    .logout-icon:hover {
      background: var(--secondary);
      color: var(--primary);
      transform: translateX(-3px);
    }

    .logout-icon svg {
      width: 24px;
      height: 24px;
    }

    /* Main Content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .dashboard-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--background);
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .top-row, .middle-row, .bottom-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin-bottom: 20px;
      gap: 20px;
    }

    .card {
      background: var(--background);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 
        0px 20px 25px -5px rgba(0, 0, 0, 0.1),
        0px 10px 10px -5px rgba(0, 0, 0, 0.04);
      box-sizing: border-box;
      flex: 1;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 
        0px 25px 30px -5px rgba(0, 0, 0, 0.15),
        0px 15px 15px -5px rgba(0, 0, 0, 0.06);
    }

    .profile-card {
      text-align: center;
      min-width: 250px;
    }

    .tracker-card {
      min-width: 300px;
    }

    .chart-card {
      min-width: 250px;
    }

    .profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 32px;
      margin: 0 auto 15px;
      color: white;
      box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
    }

    .profile-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .profile-register {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-family: 'Courier New', monospace;
      background: var(--secondary);
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .profile-details {
      margin-top: 12px;
      text-align: left;
    }

    .profile-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--secondary);
      font-size: 12px;
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    .profile-label {
      font-weight: 500;
      color: var(--text-secondary);
    }

    .profile-value {
      font-weight: 400;
      color: var(--text-primary);
      text-align: right;
    }

    .card h2 {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 15px 0;
      color: var(--primary);
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .tracker {
      margin-top: 20px;
    }

    .module {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: 8px;
      background: var(--secondary);
      margin-top: 12px;
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
      cursor: pointer;
    }

    .module:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .module.Pending {
      border-left-color: var(--warning);
      background: linear-gradient(135deg, #FEF3C7, var(--secondary));
    }

    .module.Submitted {
      border-left-color: var(--success);
      background: linear-gradient(135deg, #D1FAE5, var(--secondary));
    }

    .module.Completed {
      border-left-color: var(--primary);
      background: linear-gradient(135deg, #DBEAFE, var(--secondary));
    }

    /* Internship Details Section */
    .internship-details {
      margin-top: 15px;
      padding: 16px;
      background: linear-gradient(135deg, #EBF8FF, var(--secondary));
      border-radius: 8px;
      border-left: 4px solid var(--accent);
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid rgba(96, 165, 250, 0.1);
      font-size: 12px;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: var(--primary);
    }

    .detail-value {
      font-weight: 400;
      color: var(--text-primary);
      text-align: right;
      max-width: 60%;
      word-break: break-word;
    }

    .no-internship-message {
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 15px;
      padding: 20px;
      background: var(--secondary);
      border-radius: 8px;
    }

    .edit-details-btn {
      background: linear-gradient(135deg, var(--accent), #3B82F6);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
      width: 100%;
    }

    .edit-details-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    /* Department formatting */
    .department-display {
      text-transform: capitalize;
    }
    
    .log-item {
      padding: 12px 0;
      border-bottom: 1px solid #E5E7EB;
      transition: all 0.3s ease;
    }

    .log-item:hover {
      background: var(--secondary);
      margin: 0 -12px;
      padding: 12px;
      border-radius: 6px;
      border-bottom: 1px solid transparent;
    }

    .log-item:last-child {
      border-bottom: none;
    }

    .log-date {
      font-weight: 600;
      color: var(--primary);
    }

    /* Goal items */
    .goal-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin: 8px 0;
      background: var(--secondary);
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .goal-item:hover {
      background: #E2E8F0;
    }

    .goal-text {
      flex: 1;
      margin-right: 10px;
    }

    .goal-actions {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-complete {
      background: var(--success);
      color: white;
    }

    .btn-complete:hover {
      background: #059669;
    }

    .btn-delete {
      background: #EF4444;
      color: white;
    }

    .btn-delete:hover {
      background: #DC2626;
    }

    .goal-completed {
      opacity: 0.6;
      text-decoration: line-through;
    }

    /* Form Styles */
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input, textarea {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #E5E7EB;
      box-sizing: border-box;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    button {
      background: linear-gradient(135deg, var(--primary), #1E40AF);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--background);
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 20px 25px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 90%;
    }

    .modal-close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: var(--text-secondary);
      transition: color 0.3s ease;
    }

    .modal-close:hover {
      color: var(--primary);
    }

    /* Footer Info */
    .footer-info {
      background: var(--background);
      padding: 16px 32px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      border-top: 1px solid #E5E7EB;
      box-shadow: 0px -2px 4px rgba(0, 0, 0, 0.05);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        padding: 16px 20px;
      }

      .header-content {
        flex-direction: column;
        gap: 12px;
      }

      .university-info {
        order: -1;
      }

      .top-row, .middle-row, .bottom-row {
        flex-direction: column;
        align-items: stretch;
      }

      .profile-card, .tracker-card, .chart-card, .log-section, .form-card, .weekly-goals-card {
        width: 100%;
        min-width: auto;
        margin-bottom: 20px;
      }

      .dashboard-title {
        font-size: 24px;
      }

      .profile-details {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header with Logo -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo-link">
        <img src="logo.png" alt="Christ University Logo" class="logo">
      </a>
      <div class="university-info">
        <div class="university-name">Christ University</div>
        <div class="portal-subtitle">Internship Management Portal</div>
      </div>
      <div class="logout-icon" id="logout-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" x2="9" y1="12" y2="12"/>
        </svg>
      </div>
    </div>
  </header>

  <div class="main">
    <h1 class="dashboard-title">Student Dashboard</h1>
    
    <div class="top-row">
      <!-- Student Profile Card -->
      <div class="card profile-card">
        <div class="profile-img">üë©‚Äçüíª</div>
        <div id="student-profile">
          <div class="profile-name" id="student-name">Loading...</div>
          <div class="profile-register" id="register-number">Loading...</div>
          
          <div class="profile-details" id="profile-details">
            <!-- Profile details will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Learning Objectives & Tracker Card -->
      <div class="card tracker-card">
        <div>
          <h2>Learning Objectives</h2>
          <p id="learning-objectives" style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
            Gain practical knowledge in debugging, test driven development (TDD) and agile methodologies.
          </p>
        </div>
        <div class="tracker">
          <h2>Progress Tracker</h2>
          <div id="progress-container">
            <!-- Progress modules will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Internship Details Card -->
      <div class="card chart-card">
        <h2>Internship Details</h2>
        <div id="internship-details-container">
          <!-- Internship details will be loaded here -->
        </div>
      </div>
    </div>
    
    <div class="middle-row">
      <!-- Weekly Goals Section -->
      <div class="card weekly-goals-card">
        <h2>Weekly Goals</h2>
        <form id="addGoalForm">
          <textarea id="goalEntry" rows="2" placeholder="e.g., Complete Unit 3 of Python course." required></textarea>
          <button type="submit">Add Goal</button>
        </form>
        <div id="goals-container" style="margin-top: 15px;">
          <!-- Goals will be rendered here -->
        </div>
      </div>

      <!-- Radar Chart Card -->
      <div class="card chart-card">
        <h2>Skill Development Matrix</h2>
        <canvas id="radarChart" width="250" height="250"></canvas>
      </div>
    </div>

    <div class="bottom-row">
      <!-- Reflection and Logs Section -->
      <div class="card log-section">
        <h2>Reflection and Logs</h2>
        <div id="logs-container">
          <!-- Logs will be rendered here -->
        </div>
      </div>
      
      <!-- Forms to add logs and update skills -->
      <div class="card form-card">
        <h2>Quick Actions</h2>
        <form id="addLogForm">
          <input type="date" id="logDate" required>
          <textarea id="logEntry" rows="4" placeholder="Your reflection or log entry here..." required></textarea>
          <button type="submit">Add Log</button>
        </form>
        
        <h2 style="margin-top: 25px;">Update Skills</h2>
        <form id="updateSkillsForm">
          <div id="skill-inputs">
            <!-- Skill inputs will be dynamically generated here -->
          </div>
          <button type="submit">Update Skills</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer-info">
    <div>¬© 2025 Christ University Internship Portal | Secure Access | Academic Excellence</div>
  </footer>

  <!-- Modal for custom message box -->
  <div id="message-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modal-close-button">&times;</span>
      <p id="modal-message"></p>
    </div>
  </div>

  <script>
    // Global variables
    let radarChart = null;
    let internshipDetails = null;
    let studentProfile = null;
    
    // Data store - simulates backend data
    const dataStore = {
      progressModules: [
        { id: 1, name: 'Module 1: Introduction to Web Development', status: 'Completed' },
        { id: 2, name: 'Module 2: Database Management', status: 'Submitted' },
        { id: 3, name: 'Module 3: API Development', status: 'Pending' },
        { id: 4, name: 'Module 4: Testing & Deployment', status: 'Pending' }
      ],
      skillMatrix: {
        labels: ['Agile', 'Communication', 'Action', 'Python', 'Debugging'],
        data: [4, 3, 3, 5, 4]
      },
      logs: [
        {
          date: '2025-07-08',
          entry: 'Implemented user-login UI. Learned how design tokens drive consistency. Struggled with responsive breakpoints.'
        },
        {
          date: '2025-07-15',
          entry: 'Debugged failing test suite in payments module. Introduced logging to trace null pointer.'
        },
        {
          date: '2025-07-22',
          entry: 'Demoed first feature in sprint review‚Äîpositive feedback on accessibility compliance. Realized I underestimated QA time.'
        }
      ],
      goals: [
        { id: 1, text: 'Read two chapters of "Clean Code"', completed: false },
        { id: 2, text: 'Submit Module 3 for review', completed: false },
        { id: 3, text: 'Attend weekly stand-up meeting', completed: true }
      ]
    };

    // Utility functions
    function showMessageBox(message) {
      const modal = document.getElementById('message-modal');
      document.getElementById('modal-message').textContent = message;
      modal.style.display = 'flex';
    }

    function hideMessageBox() {
      document.getElementById('message-modal').style.display = 'none';
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      });
    }

    function generateId() {
      return Date.now() + Math.random();
    }

    function formatDepartment(department) {
      const departmentNames = {
        'computer-science': 'Computer Science Engineering',
        'information-technology': 'Information Technology',
        'electronics': 'Electronics & Communication',
        'mechanical': 'Mechanical Engineering',
        'civil': 'Civil Engineering',
        'business': 'Business Administration',
        'commerce': 'Commerce',
        'other': 'Other'
      };
      return departmentNames[department] || department;
    }

    // Load student profile from server - FIXED VERSION
    async function loadStudentProfile() {
      const registerNumber = sessionStorage.getItem('registerNumber');
      console.log('Loading profile for register number:', registerNumber);
      
      if (!registerNumber) {
        console.error('No register number found in session');
        window.location.href = '/student';
        return;
      }

      try {
        console.log('Making API call to:', `/api/student-profile/${registerNumber}`);
        const response = await fetch(`/api/student-profile/${encodeURIComponent(registerNumber)}`);
        
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Received profile data:', data);
        
        if (data.success && data.profile) {
          studentProfile = data.profile;
          renderStudentProfile(data.profile);
        } else {
          console.error('Profile data invalid:', data);
          // Fallback to session data
          renderFallbackProfile(registerNumber);
        }
      } catch (error) {
        console.error('Error loading student profile:', error);
        // Fallback to session data
        renderFallbackProfile(registerNumber);
      }
    }

    // Fallback function if API fails
    function renderFallbackProfile(registerNumber) {
      const fallbackProfile = {
        name: 'Student User',
        registerNumber: registerNumber,
        email: registerNumber + '@christuniversity.in',
        department: 'computer-science',
        phone: 'Not provided',
        createdAt: new Date().toISOString()
      };
      renderStudentProfile(fallbackProfile);
    }

    // Render student profile - FIXED VERSION
    function renderStudentProfile(profile) {
      console.log('Rendering profile:', profile);
      
      // Update the main profile display
      const nameElement = document.getElementById('student-name');
      const registerElement = document.getElementById('register-number');
      
      if (nameElement) {
        nameElement.textContent = profile.name || 'Unknown Student';
      }
      
      if (registerElement) {
        registerElement.textContent = profile.registerNumber || 'Unknown ID';
      }
      
      // Update detailed profile information
      const profileDetails = document.getElementById('profile-details');
      if (profileDetails) {
        profileDetails.innerHTML = `
          <div class="profile-item">
            <span class="profile-label">Email:</span>
            <span class="profile-value">${profile.email || 'Not provided'}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Department:</span>
            <span class="profile-value department-display">${formatDepartment(profile.department) || 'Not specified'}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Phone:</span>
            <span class="profile-value">${profile.phone || 'Not provided'}</span>
          </div>
          <div class="profile-item">
            <span class="profile-label">Joined:</span>
            <span class="profile-value">${profile.createdAt ? formatDate(profile.createdAt) : 'Unknown'}</span>
          </div>
        `;
      }
    }

    // Load internship details from server - FIXED VERSION
    async function loadInternshipDetails() {
      const registerNumber = sessionStorage.getItem('registerNumber');
      if (!registerNumber) return;

      try {
        console.log('Loading internship details for:', registerNumber);
        const response = await fetch(`/api/internship-details/${encodeURIComponent(registerNumber)}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Internship details response:', data);
        
        if (data.hasDetails) {
          internshipDetails = data.details;
          renderInternshipDetails(data.details);
          
          // Update learning objectives if provided
          if (data.details.learningObjectives) {
            document.getElementById('learning-objectives').textContent = data.details.learningObjectives;
          }
        } else {
          renderNoInternshipDetails();
        }
      } catch (error) {
        console.error('Error loading internship details:', error);
        renderNoInternshipDetails();
      }
    }

    // Render internship details
    function renderInternshipDetails(details) {
      const container = document.getElementById('internship-details-container');
      
      const internshipType = details.internshipType === 'offcampus' ? 'Off Campus' : 'On Campus';
      
      container.innerHTML = `
        <div class="internship-details">
          <div class="detail-item">
            <span class="detail-label">Type:</span>
            <span class="detail-value">${internshipType}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Company:</span>
            <span class="detail-value">${details.companyName || 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Position:</span>
            <span class="detail-value">${details.jobTitle || 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Duration:</span>
            <span class="detail-value">${details.startDate && details.endDate ? formatDate(details.startDate) + ' - ' + formatDate(details.endDate) : 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Work Mode:</span>
            <span class="detail-value">${details.workMode || 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Supervisor:</span>
            <span class="detail-value">${details.supervisorName || 'N/A'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Stipend:</span>
            <span class="detail-value">${details.stipend ? '‚Çπ' + details.stipend : 'Unpaid'}</span>
          </div>
          <button class="edit-details-btn" onclick="editInternshipDetails()">
            Edit Details
          </button>
        </div>
      `;
    }

    // Render no internship details message
    function renderNoInternshipDetails() {
      const container = document.getElementById('internship-details-container');
      container.innerHTML = `
        <div class="no-internship-message">
          <p>No internship details submitted yet.</p>
          <button class="edit-details-btn" onclick="window.location.href='/internship-type'">
            Add Details
          </button>
        </div>
      `;
    }

    // Edit internship details
    function editInternshipDetails() {
      if (confirm('Do you want to edit your internship details? This will redirect you to the form.')) {
        window.location.href = '/internship-type';
      }
    }

    // Render functions (keeping existing ones)
    function renderProgressModules() {
      const container = document.getElementById('progress-container');
      container.innerHTML = '';
      
      dataStore.progressModules.forEach(module => {
        const moduleDiv = document.createElement('div');
        moduleDiv.className = `module ${module.status}`;
        moduleDiv.innerHTML = `
          <span style="font-weight: 500;">${module.name}</span>
          <span style="font-weight: 600; text-transform: uppercase; font-size: 12px;">${module.status}</span>
        `;
        
        // Add click functionality to toggle status
        moduleDiv.addEventListener('click', () => {
          const statuses = ['Pending', 'Submitted', 'Completed'];
          const currentIndex = statuses.indexOf(module.status);
          const nextIndex = (currentIndex + 1) % statuses.length;
          module.status = statuses[nextIndex];
          renderProgressModules();
          showMessageBox(`${module.name} status updated to ${module.status}`);
        });
        
        container.appendChild(moduleDiv);
      });
    }

    function renderRadarChart() {
      const ctx = document.getElementById('radarChart').getContext('2d');
      
      if (radarChart) {
        radarChart.destroy();
      }
      
      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: dataStore.skillMatrix.labels,
          datasets: [{
            label: 'Skill Levels',
            data: dataStore.skillMatrix.data,
            backgroundColor: 'rgba(30, 58, 138, 0.2)',
            borderColor: '#1E3A8A',
            pointBackgroundColor: '#1E3A8A',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            r: {
              min: 0,
              max: 5,
              ticks: {
                stepSize: 1,
                backdropColor: 'transparent',
                color: '#6B7280',
                font: {
                  size: 10
                }
              },
              grid: {
                color: '#E5E7EB'
              },
              angleLines: {
                color: '#E5E7EB'
              },
              pointLabels: {
                font: {
                  size: 11,
                  weight: '500'
                },
                color: '#1F2937'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    function renderSkillInputs() {
      const container = document.getElementById('skill-inputs');
      container.innerHTML = '';
      
      dataStore.skillMatrix.labels.forEach((label, index) => {
        const inputGroup = document.createElement('div');
        inputGroup.style.marginBottom = '12px';
        inputGroup.innerHTML = `
          <label style="font-size: 12px; display: block; margin-bottom: 5px; color: var(--text-secondary); font-weight: 500;">
            ${label} (0-5)
          </label>
          <input type="number" id="skill-${index}" min="0" max="5" value="${dataStore.skillMatrix.data[index]}" required>
        `;
        container.appendChild(inputGroup);
      });
    }

    function renderLogs() {
      const container = document.getElementById('logs-container');
      container.innerHTML = '';
      
      // Sort logs by date (newest first)
      const sortedLogs = [...dataStore.logs].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      sortedLogs.forEach(log => {
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        logItem.innerHTML = `
          <p>
            <span class="log-date">${formatDate(log.date)}:</span> 
            ${log.entry}
          </p>
        `;
        container.appendChild(logItem);
      });
      
      if (dataStore.logs.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No logs yet. Add your first reflection!</p>';
      }
    }

    function renderGoals() {
      const container = document.getElementById('goals-container');
      container.innerHTML = '';
      
      if (dataStore.goals.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No goals set yet. Add your first goal!</p>';
        return;
      }
      
      dataStore.goals.forEach(goal => {
        const goalItem = document.createElement('div');
        goalItem.className = `goal-item ${goal.completed ? 'goal-completed' : ''}`;
        goalItem.innerHTML = `
          <div class="goal-text">${goal.text}</div>
          <div class="goal-actions">
            <button class="btn-small btn-complete" onclick="toggleGoal(${goal.id})" ${goal.completed ? 'style="display:none"' : ''}>
              ‚úì Complete
            </button>
            <button class="btn-small btn-delete" onclick="deleteGoal(${goal.id})">
              ‚úó Delete
            </button>
          </div>
        `;
        container.appendChild(goalItem);
      });
    }

    // Goal management functions
    function toggleGoal(goalId) {
      const goal = dataStore.goals.find(g => g.id === goalId);
      if (goal) {
        goal.completed = !goal.completed;
        renderGoals();
        showMessageBox(goal.completed ? 'Goal completed! üéâ' : 'Goal marked as pending');
      }
    }

    function deleteGoal(goalId) {
      if (confirm('Are you sure you want to delete this goal?')) {
        dataStore.goals = dataStore.goals.filter(g => g.id !== goalId);
        renderGoals();
        showMessageBox('Goal deleted successfully');
      }
    }

    // Event handlers
    function setupEventListeners() {
      // Add Goal Form
      document.getElementById('addGoalForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const goalText = document.getElementById('goalEntry').value.trim();
        
        if (goalText) {
          const newGoal = {
            id: generateId(),
            text: goalText,
            completed: false
          };
          
          dataStore.goals.unshift(newGoal);
          renderGoals();
          showMessageBox('Goal added successfully!');
          document.getElementById('goalEntry').value = '';
        }
      });

      // Add Log Form
      document.getElementById('addLogForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const date = document.getElementById('logDate').value;
        const entry = document.getElementById('logEntry').value.trim();
        
        if (date && entry) {
          const newLog = { date, entry };
          dataStore.logs.unshift(newLog);
          renderLogs();
          showMessageBox('Log entry added successfully!');
          document.getElementById('logDate').value = '';
          document.getElementById('logEntry').value = '';
        }
      });

      // Update Skills Form
      document.getElementById('updateSkillsForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        dataStore.skillMatrix.data = dataStore.skillMatrix.labels.map((_, index) => {
          const value = parseInt(document.getElementById(`skill-${index}`).value) || 0;
          return Math.max(0, Math.min(5, value)); // Ensure value is between 0-5
        });
        
        renderRadarChart();
        showMessageBox('Skills updated successfully!');
      });

      // Logout functionality
      document.getElementById('logout-icon').addEventListener('click', () => {
        if (confirm('Are you sure you want to logout?')) {
          sessionStorage.removeItem('registerNumber');
          window.location.href = '/';
        }
      });

      // Modal close functionality
      document.getElementById('modal-close-button').addEventListener('click', hideMessageBox);
      
      // Close modal when clicking outside
      window.addEventListener('click', (e) => {
        const modal = document.getElementById('message-modal');
        if (e.target === modal) {
          hideMessageBox();
        }
      });
    }

    // Initialization function - FIXED VERSION
    async function initDashboard() {
      console.log('Initializing dashboard...');
      
      // Check authentication
      const registerNumber = sessionStorage.getItem('registerNumber');
      if (!registerNumber) {
        console.log('No register number in session, redirecting to login');
        window.location.href = '/student';
        return;
      }
      
      console.log('Authenticated user:', registerNumber);

      // Set today's date as default in log form
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('logDate').value = today;

      // Load data with proper error handling
      try {
        console.log('Loading student profile and internship details...');
        await Promise.all([
          loadStudentProfile(),
          loadInternshipDetails()
        ]);
        console.log('Data loading completed');
      } catch (error) {
        console.error('Error during data loading:', error);
      }

      // Render all components
      renderProgressModules();
      renderRadarChart();
      renderSkillInputs();
      renderLogs();
      renderGoals();
      
      // Setup event listeners
      setupEventListeners();
      
      console.log('Dashboard initialization completed');
    }

    // Handle window resize for chart responsiveness
    window.addEventListener('resize', () => {
      if (radarChart) {
        renderRadarChart();
      }
    });

    // Make functions globally accessible for inline event handlers
    window.toggleGoal = toggleGoal;
    window.deleteGoal = deleteGoal;
    window.editInternshipDetails = editInternshipDetails;

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

</body>
</html>
